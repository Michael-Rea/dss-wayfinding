<script>

  $(document).ready(function() {
    <% if @origin %>
      var mapsProcessed = 0;
      maps.push("floor0");
      maps.push("floor1");
      maps.push("floor2");
      maps.push("floor3");
      maps.push("floor4");
      maps.push("floor5");

      var start = '<div id="';
      var end = '" class="floor" style="pointer-events: auto; display: none;"><\/div>'
      $.each(maps, function(i, map){
        var svgDiv = $(start + map + end);
        svgDiv.load("/maps/" + map + ".svg", function(){
          $("#svgImage").append(svgDiv);
          WayfindingDataStore.cleanupSVG(svgDiv);
          mapsProcessed = mapsProcessed + 1;
          if (mapsProcessed === maps.length) {
            loadImage();
          } 
        });
      });
  
      function loadImage(){
        var counter = 0;
      
        for (var i = 0; i < 6; i++){
          src = "/maps/floor" + i + ".png";
          floors[i] = new Image();
          floors[i].onload = loader;
          floors[i].src= src;

        }

        function loader(){
          if (counter < 5){
            counter++;
          } else {

            rails();
          }
        }

        function rails(){
          try {
            directory_object = jQuery.parseJSON(_.unescape("<%= raw json_escape(html_escape(@object.to_json)) %>"));

            if (directory_object) {
              showInfo(directory_object);
              routeTrigger = true;
              destination = 'R' + directory_object.room_number;

              if (destination.length > 0) {
                console.debug("destination = ", destination);
              }
            }
          } catch(e) {
            console.error('Error parsing @object to JSON', e)
          }
          $("div.ui-loader").remove();
          setVisibilities();
          <% @svg_paths = ["/maps/floor0.svg",
                           "/maps/floor1.svg",
                           "/maps/floor2.svg",
                           "/maps/floor3.svg",
                           "/maps/floor4.svg",
                           "/maps/floor5.svg"]
          %>
          <%= wayfinding_plugin(@svg_paths, asset_path("/dataStore/dataStore-" + @origin + ".json"),
            asset_path("/dataStore/dataStore-accessible-" + @origin + ".json"), @origin, @dest,) %>
          currentFloor = parseInt("<%=@origin%>".substr(1,1));
          wait();
        }

        function wait(){
          if ($("#svgImage").wayfinding('fullyLoaded') == true){
            begin();
            onLoad();
          } else {
            window.setTimeout(wait, 100);
          }
        }

        function setVisibilities(){
          $("svg").css("pointer-events", "auto");
          $("svg").find('*').css({"pointer-events":"none","opacity":"0.0"});
          $("#Rooms a").find('*').css("pointer-events", "auto");
          $(".floor").find('*').css("display", "none");
          $("svg").attr({"height":"350","width":"650"});
          $(".floor svg").css("display", "inline");
          $(".floor svg").find('#Rooms').css("display", "inline");
          $(".floor svg #data_layer").css("display", "inline");
          $(".floor svg #data_x5F_layer").css("display", "inline");
          $(".floor svg #Rooms").find('*').css("display", "inline");
          $(".floor svg #Paths").find('*').css("display", "inline");
          $("#viewing").css("display", "block");

        }
      }
    <% else %>
    // Origin is not set
      $("#mapLoadingInner").html('Kiosk location must be set in <%= link_to "administration", administration_index_path %>.');
    <% end %>
  });
</script>

<div class="show-map">
  <ul class="horizontal-nav map-actions">
    <span>Floors</span>
    <li><a href="#" id="flr-btn0" class="btn-floor">L</a></li>
    <li><a href="#" id="flr-btn1" class="btn-floor">1</a></li>
    <li><a href="#" id="flr-btn2" class="btn-floor">2</a></li>
    <li><a href="#" id="flr-btn3" class="btn-floor">3</a></li>
    <li><a href="#" id="flr-btn4" class="btn-floor">4</a></li>
    <li><a href="#" id="flr-btn5" class="btn-floor">5</a></li>
  </ul>
  <div id="map">
    <div id="viewing" width = "100%" style="position:relative; display:none;">
      <canvas id="myCanvas" style="position:relative; left:10vw; z=0; margin:auto; width:60vw; height:350;">
      </canvas>
      <div id="svgImage" style="position: absolute; margin:auto; left:10vw; top:2px; z=50;"></div>
    </div>
    <div id="mapLoading">
      <div id="mapLoadingInner">
        <%= image_tag("loader.gif", alt: "Loading") %>
      </div>
    </div>
  </div>      
  <ul class="horizontal-nav map-actions">
    <li><a href="#" class="btn-map-action icon-accessible accessible"></a></li>
    <li><a href="#" class="btn-map-action icon-repeat replay disabled"></a></li>
  </ul>
</div>

<div id="destination-view">
  <i class="btn-min-max icon-right-arrow min-max"></i>
  <h1>Destination</h1>
</div> <!-- destination-view -->
